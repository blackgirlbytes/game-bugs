name: Dashboard Regression Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      # Only trigger on dashboard-related files
      - 'src/components/LogDashboard.tsx'
      - 'src/components/logs/**'
      - 'src/utils/logUtils.ts'
      - 'src/hooks/useGameLogs.ts'
      - 'tests/components/LogDashboard.test.tsx'
      - 'tests/logs/**'
      - 'tests/utils/logUtils.test.ts'

permissions:
  contents: read
  pull-requests: write

jobs:
  check-dashboard-regression:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run Dashboard Tests
        id: test-run
        run: |
          # Run dashboard-related tests with JSON reporter
          npm test -- --testPathPattern='(LogDashboard|LogEntry|ErrorDistribution|logUtils)' --json --outputFile=test-results.json || true
          
          # Check if there were any failures and set output
          TEST_STATUS=$(cat test-results.json | jq -r '.success')
          echo "test-status=$TEST_STATUS" >> $GITHUB_OUTPUT
          
          # Save test results for Devin to analyze
          TEST_OUTPUT=$(cat test-results.json | jq -c .)
          echo "test-output=$TEST_OUTPUT" >> $GITHUB_OUTPUT

      - name: Create Devin Review Session
        id: devin-review
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          TEST_STATUS: ${{ steps.test-run.outputs.test-status }}
          TEST_OUTPUT: ${{ steps.test-run.outputs.test-output }}
          
          REVIEW_PROMPT: |
            You are Dashboard Regression Analyzer Devin. Your task is to analyze test failures in the game-logs dashboard and provide detailed feedback. Return a JSON response in one of these two formats with no other text:

            For no regressions:
            {
              "hasRegressions": false,
              "comment": "# Dashboard Review Summary âœ…\n\n## Test Results\n- All tests passing\n- No regressions detected\n\nGreat work maintaining dashboard functionality!"
            }

            For regressions found:
            {
              "hasRegressions": true,
              "filePath": "src/components/logs/LogEntry.tsx",
              "line": 15,
              "suggestion": "      timeZone: 'America/New_York'",
              "explanation": "Reverting timezone change to maintain consistency with existing snapshots and prevent display regressions. The America/New_York timezone is used throughout our tests and UI components."
            }

            Focus on:
            1. Timezone handling and display issues
            2. Log entry formatting
            3. Error distribution calculations
            4. Snapshot test failures

            Test Results:
            Status: ${{ steps.test-run.outputs.test-status }}
            Details: ${{ steps.test-run.outputs.test-output }}
        run: |
          # Make the API call to Devin
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"prompt\": \"$REVIEW_PROMPT\"}" \
            "https://api.devin.ai/v1/sessions")

          # Debug: Print the raw response
          echo "Raw Devin Response:"
          echo "$RESPONSE"

          # Extract message from response
          MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
          
          # Debug: Print the message
          echo "Extracted Message:"
          echo "$MESSAGE"

          # Set the analysis output
          echo "analysis=${MESSAGE}" >> $GITHUB_ENV

      - name: Process Devin's Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const rawAnalysis = process.env.analysis;
              console.log('Raw analysis:', rawAnalysis);
              
              if (!rawAnalysis) {
                throw new Error('No analysis received from Devin');
              }
              
              const analysis = JSON.parse(rawAnalysis);
              console.log('Parsed analysis:', analysis);
              
              if (!analysis || typeof analysis.hasRegressions !== 'boolean') {
                throw new Error('Invalid analysis format');
              }
              
              if (analysis.hasRegressions) {
                // Create a suggestion comment for the regression
                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  commit_id: context.payload.pull_request.head.sha,
                  path: analysis.filePath,
                  line: analysis.line,
                  body: `\`\`\`suggestion\n${analysis.suggestion}\n\`\`\`\n${analysis.explanation}`
                });
              } else {
                // Create a general review comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: analysis.comment
                });
              }
            } catch (error) {
              console.error('Error processing Devin analysis:', error);
              
              // Post error as PR comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `Error in dashboard regression review: ${error.message}\n\nPlease check the workflow logs for details.`
              });
              
              throw error;
            }